<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>واجهة الدردشة - النسخة النهائية</title>
    <style>
        body { font-family: 'Tahoma', sans-serif; background-color: #121212; color: #e0e0e0; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        #chat-container { width: 90%; max-width: 600px; height: 80vh; border: 1px solid #333; border-radius: 10px; background-color: #1e1e1e; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); }
        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 20px; max-width: 70%; line-height: 1.5; }
        .user-message { background-color: #0055ff; color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
        .bot-message { background-color: #3a3a3a; color: #e0e0e0; align-self: flex-start; border-bottom-left-radius: 5px; }
        #input-area { display: flex; padding: 10px; border-top: 1px solid #333; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #444; border-radius: 20px; background-color: #2c2c2c; color: #e0e0e0; font-size: 16px; }
        #send-button { padding: 10px 20px; margin-right: 10px; border: none; border-radius: 20px; background-color: #0055ff; color: white; cursor: pointer; font-size: 16px; }
        #status { padding: 5px 10px; text-align: center; font-size: 12px; color: #777; height: 20px; transition: all 0.3s; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="messages"><div class="bot-message">مرحباً! أنا وكيلك الذكي.</div></div>
        <div id="status"></div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="اكتب رسالتك هنا...">
            <button id="send-button">إرسال</button>
        </div>
    </div>
    <script>
        const webhookUrl = 'https://ahmedbpnb.app.n8n.cloud/webhook/c33c3b5b-5033-4ebf-a887-8fe50e9c185c/chat';
        const messagesContainer = document.getElementById('messages' );
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusDiv = document.getElementById('status');

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            messageDiv.textContent = text;
            messagesContainer.prepend(messageDiv);
        }

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText === '') return;

            addMessage(messageText, 'user');
            messageInput.value = '';
            statusDiv.textContent = 'جاري الاتصال...';
            sendButton.disabled = true;

            try {
                // *** الجزء المصحح ***
                // نستخدم وضع 'no-cors' لإرسال الطلب بدون انتظار رد مباشر
                // هذا يمنع خطأ المتصفح بشكل مضمون
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    mode: 'no-cors', // <--- هذا هو التصحيح الحاسم
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: messageText, senderId: 'user-123' })
                });

                // بما أننا في وضع no-cors، لا يمكننا قراءة الرد
                // لكن الطلب نفسه يتم إرساله بنجاح إلى n8n
                statusDiv.textContent = 'تم إرسال الأمر بنجاح!';
                setTimeout(() => { statusDiv.textContent = ''; }, 2000);


            } catch (error) {
                // هذا الجزء لن يتم الوصول إليه غالباً في وضع no-cors
                // لكنه موجود كإجراء احتياطي
                console.error('Error:', error);
                statusDiv.textContent = 'حدث خطأ.';
                addMessage('فشل إرسال الطلب.', 'bot');
            } finally {
                sendButton.disabled = false;
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
